{"version":3,"file":"auth-BVEEjUt6.js","sources":["../../../.svelte-kit/adapter-node/chunks/auth.js"],"sourcesContent":["import { eq } from \"drizzle-orm\";\nimport { sha256 } from \"@oslojs/crypto/sha2\";\nimport { encodeHexLowerCase, encodeBase32LowerCaseNoPadding } from \"@oslojs/encoding\";\nimport { drizzle } from \"drizzle-orm/better-sqlite3\";\nimport Database from \"better-sqlite3\";\nimport { d as private_env } from \"./shared-server.js\";\nimport { sqliteTable, text, integer } from \"drizzle-orm/sqlite-core\";\nimport dayjs from \"dayjs\";\nif (!private_env.DATABASE_URL) throw new Error(\"DATABASE_URL is not set\");\nconst client = new Database(private_env.DATABASE_URL);\nconst db = drizzle(client);\nconst user = sqliteTable(\"user\", {\n  id: text(\"id\").primaryKey(),\n  email: text(\"email\").notNull().unique(),\n  username: text(\"username\").notNull().unique(),\n  passwordHash: text(\"password_hash\").notNull(),\n  admin: integer(\"admin\").default(0)\n});\nconst product = sqliteTable(\"product\", {\n  id: text(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  image: text(\"image\").notNull(),\n  description: text(\"description\").notNull(),\n  price: text(\"price\").notNull()\n});\nconst update = sqliteTable(\"update\", {\n  id: text(\"id\").primaryKey(),\n  date: text(\"date\").notNull().$defaultFn(() => {\n    let parsing = dayjs(Date.now());\n    let date = parsing.date();\n    let strDate = `${date}`;\n    if (strDate.endsWith(\"1\")) strDate += \"st\";\n    else if (strDate.endsWith(\"2\")) strDate += \"nd\";\n    else if (strDate.endsWith(\"3\")) strDate += \"rd\";\n    else {\n      strDate += \"th\";\n    }\n    const months = [\n      \"January\",\n      \"February\",\n      \"March\",\n      \"April\",\n      \"May\",\n      \"June\",\n      \"July\",\n      \"August\",\n      \"September\",\n      \"October\",\n      \"November\",\n      \"December\"\n    ];\n    let month = months[parsing.month()];\n    let year = parsing.year();\n    return `${strDate} ${month} ${year}`;\n  }),\n  text: text(\"text\").notNull()\n});\nconst session = sqliteTable(\"session\", {\n  id: text(\"id\").primaryKey(),\n  userId: text(\"user_id\").notNull().references(() => user.id),\n  expiresAt: integer(\"expires_at\", { mode: \"timestamp\" }).notNull()\n});\nconst DAY_IN_MS = 1e3 * 60 * 60 * 24;\nconst sessionCookieName = \"auth-session\";\nfunction generateSessionToken() {\n  const bytes = crypto.getRandomValues(new Uint8Array(20));\n  const token = encodeBase32LowerCaseNoPadding(bytes);\n  return token;\n}\nasync function createSession(userId) {\n  const token = generateSessionToken();\n  const sessionId = encodeHexLowerCase(sha256(new TextEncoder().encode(token)));\n  const session$1 = {\n    id: sessionId,\n    userId,\n    expiresAt: new Date(Date.now() + DAY_IN_MS * 30)\n  };\n  await db.insert(session).values(session$1);\n  return session$1;\n}\nasync function invalidateSession(sessionId) {\n  await db.delete(session).where(eq(session.id, sessionId));\n}\nasync function validateSession(sessionId) {\n  const [result] = await db.select({\n    // Adjust user table here to tweak returned data\n    user: { id: user.id, username: user.username },\n    session\n  }).from(session).innerJoin(user, eq(session.userId, user.id)).where(eq(session.id, sessionId));\n  if (!result) {\n    return { session: null, user: null };\n  }\n  const { session: session$1, user: user$1 } = result;\n  const sessionExpired = Date.now() >= session$1.expiresAt.getTime();\n  if (sessionExpired) {\n    await db.delete(session).where(eq(session.id, session$1.id));\n    return { session: null, user: null };\n  }\n  const renewSession = Date.now() >= session$1.expiresAt.getTime() - DAY_IN_MS * 15;\n  if (renewSession) {\n    session$1.expiresAt = new Date(Date.now() + DAY_IN_MS * 30);\n    await db.update(session).set({ expiresAt: session$1.expiresAt }).where(eq(session.id, session$1.id));\n  }\n  return { session: session$1, user: user$1 };\n}\nexport {\n  user as a,\n  createSession as c,\n  db as d,\n  invalidateSession as i,\n  product as p,\n  sessionCookieName as s,\n  update as u,\n  validateSession as v\n};\n"],"names":[],"mappings":"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"}